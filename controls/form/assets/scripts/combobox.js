/** * @author  */using("Controls.Core.IDropDownMenuContainer");using("Controls.Form.CombinedTextBox");using("Controls.Form.ListBox");var ComboBox = CombinedTextBox.extend({		xType: 'combobox',		onKeyDown: function(e){		switch(e.keyCode) {			case 40:			case 38:				this.showDropDownMenu();				var newIndex, maxIndex = this.controls.length - 1, down = e.keyCode === 40 ;				if(this._currentIndex != undefined) {					this.dropDownMenu.baseSetSelected(this.controls[this._currentIndex], false);					newIndex = this._currentIndex + ( down ? 1 : -1);					if(newIndex < 0) newIndex = maxIndex;					else if(newIndex > maxIndex) newIndex = 0;				} else {					newIndex = down ? 0 : maxIndex;				}				this._currentIndex = newIndex;				this.dropDownMenu.baseSetSelected(this.controls[newIndex], true);			    e.preventDefault();			    return;			case 13:								if(this._currentIndex != undefined) {					this.dropDownMenu.setSelectedIndex(this._currentIndex);					e.preventDefault();				}		}	},		init: function (options) {		// 创建并设置下拉菜单		var dropDownMenu = new ListBox();				this.setDropDownMenu(dropDownMenu);				// 绑定点击事件		dropDownMenu.on('select', this.onSelectItem, this);				// 绑定下拉菜单		this.items = this.controls = dropDownMenu.controls;				if(this.dom.tagName === 'SELECT') {			var select = this.dom;			this.dom = this.create(options);			select.parentNode.replaceChild(this.dom, select);			dropDownMenu.copyItemsFromSelect(select);						var t = dropDownMenu.getSelectedItem();			if(t) {				dropDownMenu.clear();				this.onSelectItem(t);				}		}				// 初始化文本框		this.base('init');				// 点击下拉菜单 执行菜单显示		this.bindMenuButton('click', this.toggleDropDownMenu);				// 设置下拉菜单样式		this.setMenuButton('down');				this.on('keydown', this.onKeyDown);	},		setDropDownList: function (value) {		if(this.dom.readOnly = value !== false){			this.addClass('x-combobox-dropdownlist').on('click', this.toggleDropDownMenu);			} else {			this.removeClass('x-combobox-dropdownlist').un('click', this.toggleDropDownMenu);		}		return this;	},		getValue: function(){		this.dropDownMenu.clear();		return this.dropDownMenu.getValue();	},		setValue: function(value){		var old = this.getValue();		this.dropDownMenu.setValue(value);				var t = this.dropDownMenu.getSelectedItem();				// 如果选择的项，则表示 value 设置成功。		if(t) {			this.dropDownMenu.baseSetSelected(t, false);			this.setText(t.getText());					// 否则， 找不到对应 value 的项。		} else if(old !== value){			this.onChange();		}		return this;	},		setName: function(value) {		this.dropDownMenu.setName(value);		return this;	},		getName: function() {		return this.dropDownMenu.getName();	},		onSelectItem: function (value) {		if(this.trigger('select', value)) {			this.hideDropDownMenu();			this.setValue(this.dropDownMenu.baseGetValue(value));			this._currentIndex = undefined;		}		return false;			}}).implement(IDropDownMenuContainer).addEvents({select:{}});